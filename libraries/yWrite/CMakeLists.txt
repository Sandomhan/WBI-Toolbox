# Copyright (C) 2013 CoDyCo
# Author: Jorhabib Eljaik
# CopyPolicy: Released under the terms of the GNU GPL v2.0.

cmake_minimum_required(VERSION 2.6)
SET(PROJECTNAME yWrite)
PROJECT(${PROJECTNAME})

set(CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${YARP_MODULE_PATH})

SET(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${ICUB_LINK_FLAGS}")

FILE(GLOB folder_source ./src/*.cpp)
FILE(GLOB folder_header ./include/*.h)

source_group("Source Files" FILES ${folder_source})
source_group("Header Files" FILES ${folder_header})

include_directories(${PROJECT_SOURCE_DIR}/include)
include_directories("${MATLAB_ROOT}/simulink/include")
include_directories("${MATLAB_ROOT}/extern/include")
include_directories(${MATLAB_INCLUDE_DIR})
include_directories("${YARP_INCLUDE_DIRS}")

#Specific preprocessor flag for MATLAB MEX FILES compilation
add_definitions(-DMATLAB_MEX_FILE)

#MATLAB_MEXFILE_EXT is generated by FindMatlab.cmake
set(SFUNCTION_SUFFIX ${MATLAB_MEXFILE_EXT})

link_directories(${CMAKE_BINARY_DIR})

#Adding files used for the generation of the dynamic library
add_library(${PROJECTNAME} SHARED ${folder_source} ${folder_header})

#set(CMAKE_CXX_FLAGS "-fpermissive")

#Removing default dynamic library extensions (.dll for Windows, .so for UNIX) and prefixes (lib) otherwise automatically prepended to the mex file.
set_target_properties(${PROJECTNAME} PROPERTIES SUFFIX .${SFUNCTION_SUFFIX})
set_target_properties(${PROJECTNAME} PROPERTIES PREFIX "")

#In the following specific flags will be set to ensure compliance with the default settings of Matlab's mex compiler
if(WIN32)
	if("${MATLAB_ARCH}" STREQUAL "32")
		message("Flags have been passed to compiler for Matlab 32bits on a Windows computer")
	elseif()
		message("Flags have been passed to compiler for Matlab 64bits on a Windows computer")
	endif()
		if(MSVC)
			#Setting Compiler Flags
			set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /Z7 /nologo /W3 /WX- /O2 /Oy- /D_REENTRANT /D_CRT_SECURE_NO_DEPRECATE /D_SCL_SECURE_NO_DEPRECATE /D_SECURE_SCL=0 /DyWrite_EXPORTS /Gm- /EHs /Zp8 /GS /fp:precise /Zc:wchar_t /Zc:forScope /GR /Gd /TP /showIncludes")
			#Setting Linker Flags
			set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} /INCREMENTAL:NO /NOLOGO /MANIFEST /debug /MAP.mexw64.map /MACHINE:X64 /EXPORT:mexFunction")
			if("${MATLAB_ARCH}" STREQUAL "32")
				#Changing some flags according to system/MATLAB version (32, 64 bits)
				set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} /MAP.mexw32.map /MACHINE:X32")
			endif()
		elseif(MSVC)
			message("You are not compiling using Microsoft Visual Studio, ERRORS might occur")
		endif(MSVC)
elseif(WIN32)
	message("No particular flags have been passed to compiler for Matlab 64bits on a UNIX computer")
endif(WIN32)

# Linking Libraries
target_link_libraries(${PROJECTNAME} ${YARP_LIBRARIES} ${MATLAB_LIBRARIES})
install(TARGETS ${PROJECTNAME} DESTINATION mex)
	






